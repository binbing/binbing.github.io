<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="生成证书在这个部分，将需要产生多个元件的 Certificates，这包含 Etcd、Kubernetes 元件等，并且每个集群都会有一个根数位凭证认证机构 (Root Certificate Authority) 被用在认证 API Server 与 Kubelet 端的凭证。 P.S. 这边要注意 CA JSON 档的 CN(Common Name)与O(Organization) 等内容是会">
<meta property="og:type" content="article">
<meta property="og:title" content="虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书">
<meta property="og:url" content="xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/index.html">
<meta property="og:site_name" content="萧非瑟">
<meta property="og:description" content="生成证书在这个部分，将需要产生多个元件的 Certificates，这包含 Etcd、Kubernetes 元件等，并且每个集群都会有一个根数位凭证认证机构 (Root Certificate Authority) 被用在认证 API Server 与 Kubelet 端的凭证。 P.S. 这边要注意 CA JSON 档的 CN(Common Name)与O(Organization) 等内容是会">
<meta property="og:updated_time" content="2018-08-20T10:12:03.591Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书">
<meta name="twitter:description" content="生成证书在这个部分，将需要产生多个元件的 Certificates，这包含 Etcd、Kubernetes 元件等，并且每个集群都会有一个根数位凭证认证机构 (Root Certificate Authority) 被用在认证 API Server 与 Kubelet 端的凭证。 P.S. 这边要注意 CA JSON 档的 CN(Common Name)与O(Organization) 等内容是会">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 03 部署 Master/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 01 虚拟机环境准备/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#生成证书"><span class="toc-number">1.</span> <span class="toc-text">生成证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备工作"><span class="toc-number">1.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-CA-证书和秘钥"><span class="toc-number">1.2.</span> <span class="toc-text">创建 CA 证书和秘钥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建证书文件夹"><span class="toc-number">1.2.1.</span> <span class="toc-text">创建证书文件夹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-CA-配置文件："><span class="toc-number">1.2.2.</span> <span class="toc-text">创建 CA 配置文件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-CA-证书签名请求："><span class="toc-number">1.2.3.</span> <span class="toc-text">创建 CA 证书签名请求：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-CA-keys-与-Certificate"><span class="toc-number">1.2.4.</span> <span class="toc-text">生成 CA keys 与 Certificate</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Etcd"><span class="toc-number">1.3.</span> <span class="toc-text">Etcd</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-Etcd-证书文件夹"><span class="toc-number">1.3.1.</span> <span class="toc-text">创建 Etcd 证书文件夹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-TLS-秘钥和证书"><span class="toc-number">1.3.2.</span> <span class="toc-text">创建 TLS 秘钥和证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分发文件"><span class="toc-number">1.3.3.</span> <span class="toc-text">分发文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubernetes"><span class="toc-number">1.4.</span> <span class="toc-text">Kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#回到证书文件夹"><span class="toc-number">1.4.1.</span> <span class="toc-text">回到证书文件夹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-kube-apiserver-凭证"><span class="toc-number">1.4.2.</span> <span class="toc-text">生成 kube-apiserver 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-Front-Proxy-凭证"><span class="toc-number">1.4.3.</span> <span class="toc-text">生成 Front Proxy 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-admin-凭证"><span class="toc-number">1.4.4.</span> <span class="toc-text">生成 admin 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-Controller-Manager-凭证"><span class="toc-number">1.4.5.</span> <span class="toc-text">生成 Controller Manager 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-Scheduler-凭证"><span class="toc-number">1.4.6.</span> <span class="toc-text">生成 Scheduler 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-Master-Kubelet-凭证"><span class="toc-number">1.4.7.</span> <span class="toc-text">生成 Master Kubelet 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-Service-Account-凭证"><span class="toc-number">1.4.8.</span> <span class="toc-text">生成 Service Account 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分发文件-1"><span class="toc-number">1.4.9.</span> <span class="toc-text">分发文件</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">萧非瑟</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-05-30T17:53:17.000Z" itemprop="datePublished">2018-05-30</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h2><p>在这个部分，将需要产生多个元件的 Certificates，这包含 Etcd、Kubernetes 元件等，并且每个集群都会有一个根数位凭证认证机构 (Root Certificate Authority) 被用在认证 API Server 与 Kubelet 端的凭证。</p>
<p>P.S. 这边要注意 CA JSON 档的 CN(Common Name)与O(Organization) 等内容是会影响 Kubernetes 元件认证的。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>在主机 kube-m1 上安装 cfssl ，在任意目录执行以下命令 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ wget https://pkg.cfssl.org/R1.3.2/cfssl_linux-amd64 &amp;&amp; chmod +x cfssl_linux-amd64 &amp;&amp; mv cfssl_linux-amd64 /usr/local/bin/cfssl</div><div class="line"></div><div class="line">$ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 &amp;&amp; chmod +x cfssljson_linux-amd64 &amp;&amp; mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</div><div class="line"></div><div class="line">$ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 &amp;&amp; chmod +x cfssl-certinfo_linux-amd64 &amp;&amp; mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</div></pre></td></tr></table></figure>
<h3 id="创建-CA-证书和秘钥"><a href="#创建-CA-证书和秘钥" class="headerlink" title="创建 CA 证书和秘钥"></a>创建 CA 证书和秘钥</h3><p>CA 证书 k8s 和 etcd 共用一份，放在 <code>/etc/kubernetes/ssl</code> 下。</p>
<h4 id="创建证书文件夹"><a href="#创建证书文件夹" class="headerlink" title="创建证书文件夹"></a>创建证书文件夹</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/kubernetes/ssl &amp;&amp; cd /etc/kubernetes/ssl</div></pre></td></tr></table></figure>
<h4 id="创建-CA-配置文件："><a href="#创建-CA-配置文件：" class="headerlink" title="创建 CA 配置文件："></a>创建 CA 配置文件：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">$ cat &gt; ca-config.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  &quot;signing&quot;: &#123;</div><div class="line">    &quot;default&quot;: &#123;</div><div class="line">      &quot;expiry&quot;: &quot;8760h&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;profiles&quot;: &#123;</div><div class="line">      &quot;kubernetes&quot;: &#123;</div><div class="line">        &quot;usages&quot;: [</div><div class="line">            &quot;signing&quot;,</div><div class="line">            &quot;key encipherment&quot;,</div><div class="line">            &quot;server auth&quot;,</div><div class="line">            &quot;client auth&quot;</div><div class="line">        ],</div><div class="line">        &quot;expiry&quot;: &quot;8760h&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<ul>
<li>ca-config.json：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</li>
<li>signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；</li>
<li>server auth：表示 client 可以用该 CA 对 server 提供的证书进行验证；</li>
<li>client auth：表示 server 可以用该 CA 对 client 提供的证书进行验证。</li>
</ul>
<h4 id="创建-CA-证书签名请求："><a href="#创建-CA-证书签名请求：" class="headerlink" title="创建 CA 证书签名请求："></a>创建 CA 证书签名请求：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$ cat &gt; ca-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</div><div class="line">  &quot;key&quot;: &#123;</div><div class="line">    &quot;algo&quot;: &quot;rsa&quot;,</div><div class="line">    &quot;size&quot;: 2048</div><div class="line">  &#125;,</div><div class="line">  &quot;names&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;C&quot;: &quot;CN&quot;,</div><div class="line">      &quot;ST&quot;: &quot;ShenZhen&quot;,</div><div class="line">      &quot;L&quot;: &quot;ShenZhen&quot;,</div><div class="line">      &quot;O&quot;: &quot;Kubernetes&quot;,</div><div class="line">      &quot;OU&quot;: &quot;4Paradigm&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<ul>
<li>CN”：<code>Common Name</code>，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li>
<li>“O”：<code>Organization</code>，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</li>
</ul>
<h4 id="生成-CA-keys-与-Certificate"><a href="#生成-CA-keys-与-Certificate" class="headerlink" title="生成 CA keys 与 Certificate"></a>生成 CA keys 与 Certificate</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca</div><div class="line">$ ls ca*</div><div class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</div></pre></td></tr></table></figure>
<h3 id="Etcd"><a href="#Etcd" class="headerlink" title="Etcd"></a>Etcd</h3><p>在此步骤中将创建与 Etcd 相关的证书文件。</p>
<h4 id="创建-Etcd-证书文件夹"><a href="#创建-Etcd-证书文件夹" class="headerlink" title="创建 Etcd 证书文件夹"></a>创建 Etcd 证书文件夹</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /etc/etcd/ssl &amp;&amp; cd /etc/etcd/ssl</div></pre></td></tr></table></figure>
<h4 id="创建-TLS-秘钥和证书"><a href="#创建-TLS-秘钥和证书" class="headerlink" title="创建 TLS 秘钥和证书"></a>创建 TLS 秘钥和证书</h4><p>为了保证通信安全，客户端(如 etcdctl) 与 etcd 集群、etcd 集群之间的通信需要使用 TLS 加密，本节创建 etcd TLS 加密所需的证书和私钥。</p>
<p>创建 etcd 证书签名请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">$ cat &gt; etcd-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  &quot;CN&quot;: &quot;etcd&quot;,</div><div class="line">  &quot;hosts&quot;: [</div><div class="line">    &quot;127.0.0.1&quot;,</div><div class="line">    &quot;192.168.56.11&quot;,</div><div class="line">    &quot;192.168.56.12&quot;,</div><div class="line">    &quot;192.168.56.13&quot;</div><div class="line">  ],</div><div class="line">  &quot;key&quot;: &#123;</div><div class="line">    &quot;algo&quot;: &quot;rsa&quot;,</div><div class="line">    &quot;size&quot;: 2048</div><div class="line">  &#125;,</div><div class="line">  &quot;names&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;C&quot;: &quot;CN&quot;,</div><div class="line">      &quot;ST&quot;: &quot;ShenZhen&quot;,</div><div class="line">      &quot;L&quot;: &quot;ShenZhen&quot;,</div><div class="line">      &quot;O&quot;: &quot;Kubernetes&quot;,</div><div class="line">      &quot;OU&quot;: &quot;4Paradigm&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<ul>
<li>hosts 字段指定授权使用该证书的 etcd 节点 IP，在这里指三台 Master 主机。</li>
</ul>
<p>生成 etcd 证书和私钥：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  -ca-key=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  -config=/etc/kubernetes/ssl/ca-config.json \</div><div class="line">  -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</div><div class="line"></div><div class="line">$ ls etcd*.pem</div><div class="line">etcd-key.pem etcd.pem</div></pre></td></tr></table></figure>
<h4 id="分发文件"><a href="#分发文件" class="headerlink" title="分发文件"></a>分发文件</h4><p>分发前先删除不必要文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/etcd/ssl</div><div class="line"></div><div class="line">$ rm -rf *.json *.csr</div><div class="line"></div><div class="line">$ ls /etc/etcd/ssl</div><div class="line">etcd-key.pem  etcd.pem</div></pre></td></tr></table></figure>
<p>复制相关文件至其他 Etcd 节点，这边为所有master节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ for NODE in kube-m2 kube-m3; do</div><div class="line">    echo &quot;--- $NODE ---&quot;</div><div class="line">    ssh $&#123;NODE&#125; &quot;mkdir -p /etc/etcd/ssl&quot;</div><div class="line">    for FILE in etcd-key.pem  etcd.pem; do</div><div class="line">      scp /etc/etcd/ssl/$&#123;FILE&#125; $&#123;NODE&#125;:/etc/etcd/ssl/$&#123;FILE&#125;</div><div class="line">    done</div><div class="line">done</div></pre></td></tr></table></figure>
<h3 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h3><p>在此步骤中将创建与 Kubernetes 相关的证书文件。</p>
<h4 id="回到证书文件夹"><a href="#回到证书文件夹" class="headerlink" title="回到证书文件夹"></a>回到证书文件夹</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes/ssl</div></pre></td></tr></table></figure>
<h4 id="生成-kube-apiserver-凭证"><a href="#生成-kube-apiserver-凭证" class="headerlink" title="生成 kube-apiserver 凭证"></a>生成 kube-apiserver 凭证</h4><p>创建 Api Server 证书签名请求:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">$ cat &gt; /etc/kubernetes/ssl/apiserver-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  &quot;CN&quot;: &quot;kube-apiserver&quot;,</div><div class="line">  &quot;hosts&quot;: [</div><div class="line">    &quot;127.0.0.1&quot;,</div><div class="line">    &quot;192.168.56.10&quot;,</div><div class="line">    &quot;10.254.0.1&quot;,</div><div class="line">    &quot;kubernetes&quot;,</div><div class="line">    &quot;kubernetes.default&quot;,</div><div class="line">    &quot;kubernetes.default.svc&quot;,</div><div class="line">    &quot;kubernetes.default.svc.cluster&quot;,</div><div class="line">    &quot;kubernetes.default.svc.cluster.local&quot;</div><div class="line">  ],</div><div class="line">  &quot;key&quot;: &#123;</div><div class="line">    &quot;algo&quot;: &quot;rsa&quot;,</div><div class="line">    &quot;size&quot;: 2048</div><div class="line">  &#125;,</div><div class="line">  &quot;names&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;C&quot;: &quot;CN&quot;,</div><div class="line">      &quot;ST&quot;: &quot;ShenZhen&quot;,</div><div class="line">      &quot;L&quot;: &quot;ShenZhen&quot;,</div><div class="line">      &quot;O&quot;: &quot;Kubernetes&quot;,</div><div class="line">      &quot;OU&quot;: &quot;4Paradigm&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<ul>
<li><code>192.168.56.10</code> 为 虚拟 IP；</li>
<li><code>10.254.0.1</code> 为 kube-apiserver –service-cluster-ip-range 选项值指定的网段的第一个IP，如 “10.254.0.1”。</li>
</ul>
<p>生成 Api Server 证书和私钥:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes/ssl &amp;&amp; cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  -ca-key=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  -config=/etc/kubernetes/ssl/ca-config.json \</div><div class="line">  -profile=kubernetes /etc/kubernetes/ssl/apiserver-csr.json | cfssljson -bare apiserver</div><div class="line"></div><div class="line">$ ls apiserver*.pem</div><div class="line">apiserver-key.pem  apiserver.pem</div></pre></td></tr></table></figure>
<h4 id="生成-Front-Proxy-凭证"><a href="#生成-Front-Proxy-凭证" class="headerlink" title="生成 Front Proxy 凭证"></a>生成 Front Proxy 凭证</h4><p>创建 Front Proxy 证书签名请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ cat &gt; /etc/kubernetes/ssl/front-proxy-client-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  &quot;CN&quot;: &quot;front-proxy-client&quot;,</div><div class="line">  &quot;hosts&quot;: [],</div><div class="line">  &quot;key&quot;: &#123;</div><div class="line">    &quot;algo&quot;: &quot;rsa&quot;,</div><div class="line">    &quot;size&quot;: 2048</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>生成 Front Proxy 证书和私钥:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes/ssl &amp;&amp; cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  -ca-key=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  -config=/etc/kubernetes/ssl/ca-config.json \</div><div class="line">  -profile=kubernetes /etc/kubernetes/ssl/front-proxy-client-csr.json | cfssljson -bare front-proxy-client</div><div class="line"></div><div class="line">$ ls front-proxy-client*.pem</div><div class="line">front-proxy-client-key.pem  front-proxy-client.pem</div></pre></td></tr></table></figure>
<h4 id="生成-admin-凭证"><a href="#生成-admin-凭证" class="headerlink" title="生成 admin 凭证"></a>生成 admin 凭证</h4><p>创建 admin 证书签名请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ cat &gt; /etc/kubernetes/ssl/admin-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    &quot;CN&quot;:&quot;admin&quot;,</div><div class="line">    &quot;hosts&quot;: [],</div><div class="line">    &quot;key&quot;:&#123;</div><div class="line">        &quot;algo&quot;:&quot;rsa&quot;,</div><div class="line">        &quot;size&quot;:2048</div><div class="line">    &#125;,</div><div class="line">    &quot;names&quot;:[&#123;</div><div class="line">        &quot;C&quot;:&quot;CN&quot;,</div><div class="line">        &quot;ST&quot;:&quot;Shenzhen&quot;,</div><div class="line">        &quot;L&quot;:&quot;Shenzhen&quot;,</div><div class="line">        &quot;O&quot;:&quot;system:masters&quot;,</div><div class="line">        &quot;OU&quot;:&quot;4Paradigm&quot;</div><div class="line">        &#125;]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>生成 admin 证书和私钥:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes/ssl &amp;&amp; cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  -ca-key=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  -config=/etc/kubernetes/ssl/ca-config.json \</div><div class="line">  -profile=kubernetes admin-csr.json | cfssljson -bare admin</div><div class="line"></div><div class="line">$ ls admin*.pem</div><div class="line">admin-key.pem  admin.pem</div></pre></td></tr></table></figure></p>
<p>生成 kubectl kubeconfig 文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes</div><div class="line"></div><div class="line">$ export KUBE_APISERVER=&quot;https://192.168.56.10:6443&quot;</div><div class="line"></div><div class="line">$ # 设置集群参数</div><div class="line">$ kubectl config set-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --embed-certs=true \</div><div class="line">  --server=$&#123;KUBE_APISERVER&#125; \</div><div class="line">  --kubeconfig=/etc/kubernetes/admin.conf</div><div class="line"></div><div class="line">$ # 设置客户端认证参数</div><div class="line">$ kubectl config set-credentials kubernetes-admin \</div><div class="line">  --client-certificate=/etc/kubernetes/ssl/admin.pem \</div><div class="line">  --embed-certs=true \</div><div class="line">  --client-key=/etc/kubernetes/ssl/admin-key.pem \</div><div class="line">  --kubeconfig=/etc/kubernetes/admin.conf</div><div class="line"></div><div class="line">$ # 设置上下文参数</div><div class="line">$ kubectl config set-context kubernetes-admin@kubernetes \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=kubernetes-admin \</div><div class="line">  --kubeconfig=/etc/kubernetes/admin.conf</div><div class="line">  </div><div class="line">$ # 设置默认上下文</div><div class="line">$ kubectl config use-context kubernetes-admin@kubernetes \</div><div class="line">  --kubeconfig=/etc/kubernetes/admin.conf</div></pre></td></tr></table></figure>
<h4 id="生成-Controller-Manager-凭证"><a href="#生成-Controller-Manager-凭证" class="headerlink" title="生成 Controller Manager 凭证"></a>生成 Controller Manager 凭证</h4><p>创建 Controller Manager 证书签名请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ cat &gt; /etc/kubernetes/ssl/controller-manager-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    &quot;CN&quot;:&quot;system:kube-controller-manager&quot;,</div><div class="line">    &quot;hosts&quot;: [],</div><div class="line">    &quot;key&quot;:&#123;</div><div class="line">        &quot;algo&quot;:&quot;rsa&quot;,</div><div class="line">        &quot;size&quot;:2048</div><div class="line">    &#125;,</div><div class="line">    &quot;names&quot;:[&#123;</div><div class="line">        &quot;C&quot;:&quot;CN&quot;,</div><div class="line">        &quot;ST&quot;:&quot;Shenzhen&quot;,</div><div class="line">        &quot;L&quot;:&quot;Shenzhen&quot;,</div><div class="line">        &quot;O&quot;:&quot;system:kube-controller-manager&quot;,</div><div class="line">        &quot;OU&quot;:&quot;4Paradigm&quot;</div><div class="line">        &#125;]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>生成 Controller Manager 证书和私钥:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes/ssl &amp;&amp; cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  -ca-key=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  -config=/etc/kubernetes/ssl/ca-config.json \</div><div class="line">  -profile=kubernetes controller-manager-csr.json | cfssljson -bare controller-manager</div><div class="line"></div><div class="line">$ ls controller-manager*.pem</div><div class="line">controller-manager-key.pem  controller-manager.pem</div></pre></td></tr></table></figure></p>
<p>生成 Controller Manager kubeconfig 文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes</div><div class="line"></div><div class="line">$ export KUBE_APISERVER=&quot;https://192.168.56.10:6443&quot;</div><div class="line"></div><div class="line">$ # 设置集群参数</div><div class="line">$ kubectl config set-cluster kubernetes \</div><div class="line">    --certificate-authority=/etc/kubernetes/ssl/ca.pem \</div><div class="line">    --embed-certs=true \</div><div class="line">    --server=$&#123;KUBE_APISERVER&#125; \</div><div class="line">    --kubeconfig=/etc/kubernetes/controller-manager.conf</div><div class="line"></div><div class="line">$ # 设置客户端认证参数</div><div class="line">$ kubectl config set-credentials system:kube-controller-manager \</div><div class="line">    --client-certificate=/etc/kubernetes/ssl/controller-manager.pem \</div><div class="line">    --client-key=/etc/kubernetes/ssl/controller-manager-key.pem \</div><div class="line">    --embed-certs=true \</div><div class="line">    --kubeconfig=/etc/kubernetes/controller-manager.conf</div><div class="line"></div><div class="line">$ # 设置上下文参数</div><div class="line">$ kubectl config set-context system:kube-controller-manager@kubernetes \</div><div class="line">    --cluster=kubernetes \</div><div class="line">    --user=system:kube-controller-manager \</div><div class="line">    --kubeconfig=/etc/kubernetes/controller-manager.conf</div><div class="line">  </div><div class="line">$ # 设置默认上下文</div><div class="line">$ kubectl config use-context system:kube-controller-manager@kubernetes \</div><div class="line">    --kubeconfig=/etc/kubernetes/controller-manager.conf</div></pre></td></tr></table></figure>
<h4 id="生成-Scheduler-凭证"><a href="#生成-Scheduler-凭证" class="headerlink" title="生成 Scheduler 凭证"></a>生成 Scheduler 凭证</h4><p>创建 Scheduler 证书签名请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ cat &gt; /etc/kubernetes/ssl/scheduler-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    &quot;CN&quot;:&quot;system:kube-scheduler&quot;,</div><div class="line">    &quot;hosts&quot;: [],</div><div class="line">    &quot;key&quot;:&#123;</div><div class="line">        &quot;algo&quot;:&quot;rsa&quot;,</div><div class="line">        &quot;size&quot;:2048</div><div class="line">    &#125;,</div><div class="line">    &quot;names&quot;:[&#123;</div><div class="line">        &quot;C&quot;:&quot;CN&quot;,</div><div class="line">        &quot;ST&quot;:&quot;Shenzhen&quot;,</div><div class="line">        &quot;L&quot;:&quot;Shenzhen&quot;,</div><div class="line">        &quot;O&quot;:&quot;system:kube-scheduler&quot;,</div><div class="line">        &quot;OU&quot;:&quot;4Paradigm&quot;</div><div class="line">        &#125;]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>生成 Scheduler 证书和私钥:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes/ssl &amp;&amp; cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  -ca-key=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">  -config=/etc/kubernetes/ssl/ca-config.json \</div><div class="line">  -profile=kubernetes scheduler-csr.json | cfssljson -bare scheduler</div><div class="line"></div><div class="line">$ ls scheduler*.pem</div><div class="line">scheduler-key.pem  scheduler.pem</div></pre></td></tr></table></figure></p>
<p>生成 Scheduler kubeconfig 文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes</div><div class="line"></div><div class="line">$ export KUBE_APISERVER=&quot;https://192.168.56.10:6443&quot;</div><div class="line"></div><div class="line">$ # 设置集群参数</div><div class="line">$ kubectl config set-cluster kubernetes \</div><div class="line">    --certificate-authority=/etc/kubernetes/ssl/ca.pem \</div><div class="line">    --embed-certs=true \</div><div class="line">    --server=$&#123;KUBE_APISERVER&#125; \</div><div class="line">    --kubeconfig=/etc/kubernetes/scheduler.conf</div><div class="line"></div><div class="line">$ # 设置客户端认证参数</div><div class="line">$ kubectl config set-credentials system:kube-scheduler \</div><div class="line">    --client-certificate=/etc/kubernetes/ssl/scheduler.pem \</div><div class="line">    --client-key=/etc/kubernetes/ssl/scheduler-key.pem \</div><div class="line">    --embed-certs=true \</div><div class="line">    --kubeconfig=/etc/kubernetes/scheduler.conf</div><div class="line"></div><div class="line">$ # 设置上下文参数</div><div class="line">$ kubectl config set-context system:kube-scheduler@kubernetes \</div><div class="line">    --cluster=kubernetes \</div><div class="line">    --user=system:kube-scheduler \</div><div class="line">    --kubeconfig=/etc/kubernetes/scheduler.conf</div><div class="line">  </div><div class="line">$ # 设置默认上下文</div><div class="line">$ kubectl config use-context system:kube-scheduler@kubernetes \</div><div class="line">    --kubeconfig=/etc/kubernetes/scheduler.conf</div></pre></td></tr></table></figure>
<h4 id="生成-Master-Kubelet-凭证"><a href="#生成-Master-Kubelet-凭证" class="headerlink" title="生成 Master Kubelet 凭证"></a>生成 Master Kubelet 凭证</h4><p>创建 Master Kubelet 证书签名请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ cat &gt; /etc/kubernetes/ssl/kubelet-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    &quot;CN&quot;:&quot;system:node:\$NODE&quot;,</div><div class="line">    &quot;hosts&quot;: [],</div><div class="line">    &quot;key&quot;:&#123;</div><div class="line">        &quot;algo&quot;:&quot;rsa&quot;,</div><div class="line">        &quot;size&quot;:2048</div><div class="line">    &#125;,</div><div class="line">    &quot;names&quot;:[&#123;</div><div class="line">        &quot;C&quot;:&quot;CN&quot;,</div><div class="line">        &quot;ST&quot;:&quot;Shenzhen&quot;,</div><div class="line">        &quot;L&quot;:&quot;Shenzhen&quot;,</div><div class="line">        &quot;O&quot;:&quot;system:nodes&quot;,</div><div class="line">        &quot;OU&quot;:&quot;4Paradigm&quot;</div><div class="line">        &#125;]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>生成 所有 Master Kubelet 证书和私钥:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes/ssl</div><div class="line">$ for NODE in kube-m1 kube-m2 kube-m3; do</div><div class="line">    echo &quot;--- $NODE ---&quot;</div><div class="line">    cp kubelet-csr.json kubelet-$NODE-csr.json;</div><div class="line">    sed -i &quot;s/\$NODE/$NODE/g&quot; kubelet-$NODE-csr.json;</div><div class="line">    cfssl gencert \</div><div class="line">      -ca=/etc/kubernetes/ssl/ca.pem \</div><div class="line">      -ca-key=/etc/kubernetes/ssl/ca-key.pem \</div><div class="line">      -config=/etc/kubernetes/ssl/ca-config.json \</div><div class="line">      -hostname=$NODE \</div><div class="line">      -profile=kubernetes \</div><div class="line">      kubelet-$NODE-csr.json | cfssljson -bare kubelet-$NODE</div><div class="line">done</div><div class="line">$ ls kubelet*.pem</div><div class="line">kubelet-kube-m1-key.pem  kubelet-kube-m1.pem  kubelet-kube-m2-key.pem  kubelet-kube-m2.pem  kubelet-kube-m3-key.pem  kubelet-kube-m3.pem</div></pre></td></tr></table></figure></p>
<p>完成后复制 kubelet 凭证至其他 master 节点:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ for NODE in kube-m2 kube-m3; do</div><div class="line">    echo &quot;--- $NODE ---&quot;</div><div class="line">    ssh $&#123;NODE&#125; &quot;mkdir -p /etc/kubernetes/ssl&quot;</div><div class="line">    for FILE in kubelet-$NODE-key.pem kubelet-$NODE.pem ca.pem; do</div><div class="line">      scp /etc/kubernetes/ssl/$&#123;FILE&#125; $&#123;NODE&#125;:/etc/kubernetes/ssl/$&#123;FILE&#125;</div><div class="line">    done</div><div class="line">done</div></pre></td></tr></table></figure>
<p>生成 Kubelet kubeconfig 文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">$ for NODE in kube-m1 kube-m2 kube-m3; do</div><div class="line">    echo &quot;--- $NODE ---&quot;</div><div class="line">    ssh $&#123;NODE&#125; &quot;cd /etc/kubernetes/ssl &amp;&amp; \</div><div class="line">      kubectl config set-cluster kubernetes \</div><div class="line">        --certificate-authority=ca.pem \</div><div class="line">        --embed-certs=true \</div><div class="line">        --server=$&#123;KUBE_APISERVER&#125; \</div><div class="line">        --kubeconfig=../kubelet.conf &amp;&amp; \</div><div class="line">      kubectl config set-cluster kubernetes \</div><div class="line">        --certificate-authority=ca.pem \</div><div class="line">        --embed-certs=true \</div><div class="line">        --server=$&#123;KUBE_APISERVER&#125; \</div><div class="line">        --kubeconfig=../kubelet.conf &amp;&amp; \</div><div class="line">      kubectl config set-credentials system:node:$&#123;NODE&#125; \</div><div class="line">        --client-certificate=kubelet-$&#123;NODE&#125;.pem \</div><div class="line">        --client-key=kubelet-$&#123;NODE&#125;-key.pem \</div><div class="line">        --embed-certs=true \</div><div class="line">        --kubeconfig=../kubelet.conf &amp;&amp; \</div><div class="line">      kubectl config set-context system:node:$&#123;NODE&#125;@kubernetes \</div><div class="line">        --cluster=kubernetes \</div><div class="line">        --user=system:node:$&#123;NODE&#125; \</div><div class="line">        --kubeconfig=../kubelet.conf &amp;&amp; \</div><div class="line">      kubectl config use-context system:node:$&#123;NODE&#125;@kubernetes \</div><div class="line">        --kubeconfig=../kubelet.conf &amp;&amp; \</div><div class="line">      rm kubelet-$&#123;NODE&#125;.pem kubelet-$&#123;NODE&#125;-key.pem&quot;</div><div class="line">done</div></pre></td></tr></table></figure>
<h4 id="生成-Service-Account-凭证"><a href="#生成-Service-Account-凭证" class="headerlink" title="生成 Service Account 凭证"></a>生成 Service Account 凭证</h4><p>Service account 不是通过 CA 进行认证，因此不要通过 CA 来做 Service account key 的检查，这边建立一组 Private 与 Public 金钥提供给 Service account key 使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes/ssl</div><div class="line">$ openssl genrsa -out sa.key 2048</div><div class="line"></div><div class="line">$ openssl rsa -in sa.key -pubout -out sa.pub</div><div class="line"></div><div class="line">$ ls sa.*</div><div class="line">sa.key  sa.pub</div></pre></td></tr></table></figure>
<h4 id="分发文件-1"><a href="#分发文件-1" class="headerlink" title="分发文件"></a>分发文件</h4><p>分发前先将无用的文件删除：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd /etc/kubernetes/ssl</div><div class="line">$ rm -rf *.json *.csr scheduler*.pem controller-manager*.pem admin*.pem kubelet*.pem</div></pre></td></tr></table></figure>
<p>将凭证文件分发到其他 Master 节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ for NODE in kube-m2 kube-m3; do</div><div class="line">    echo &quot;--- $NODE ---&quot;</div><div class="line">    for FILE in $(ls /etc/kubernetes/ssl/); do</div><div class="line">      scp /etc/kubernetes/ssl/$&#123;FILE&#125; $&#123;NODE&#125;:/etc/kubernetes/ssl/$&#123;FILE&#125;</div><div class="line">    done</div><div class="line">done</div></pre></td></tr></table></figure>
<p>复制 Kubernetes config 文件至其他master节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ for NODE in kube-m2 kube-m3; do</div><div class="line">    echo &quot;--- $NODE ---&quot;</div><div class="line">    for FILE in admin.conf controller-manager.conf scheduler.conf; do</div><div class="line">      scp /etc/kubernetes/$&#123;FILE&#125; $&#123;NODE&#125;:/etc/kubernetes/$&#123;FILE&#125;</div><div class="line">    done</div><div class="line">done</div></pre></td></tr></table></figure>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#生成证书"><span class="toc-number">1.</span> <span class="toc-text">生成证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备工作"><span class="toc-number">1.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-CA-证书和秘钥"><span class="toc-number">1.2.</span> <span class="toc-text">创建 CA 证书和秘钥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建证书文件夹"><span class="toc-number">1.2.1.</span> <span class="toc-text">创建证书文件夹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-CA-配置文件："><span class="toc-number">1.2.2.</span> <span class="toc-text">创建 CA 配置文件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-CA-证书签名请求："><span class="toc-number">1.2.3.</span> <span class="toc-text">创建 CA 证书签名请求：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-CA-keys-与-Certificate"><span class="toc-number">1.2.4.</span> <span class="toc-text">生成 CA keys 与 Certificate</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Etcd"><span class="toc-number">1.3.</span> <span class="toc-text">Etcd</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-Etcd-证书文件夹"><span class="toc-number">1.3.1.</span> <span class="toc-text">创建 Etcd 证书文件夹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-TLS-秘钥和证书"><span class="toc-number">1.3.2.</span> <span class="toc-text">创建 TLS 秘钥和证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分发文件"><span class="toc-number">1.3.3.</span> <span class="toc-text">分发文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubernetes"><span class="toc-number">1.4.</span> <span class="toc-text">Kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#回到证书文件夹"><span class="toc-number">1.4.1.</span> <span class="toc-text">回到证书文件夹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-kube-apiserver-凭证"><span class="toc-number">1.4.2.</span> <span class="toc-text">生成 kube-apiserver 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-Front-Proxy-凭证"><span class="toc-number">1.4.3.</span> <span class="toc-text">生成 Front Proxy 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-admin-凭证"><span class="toc-number">1.4.4.</span> <span class="toc-text">生成 admin 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-Controller-Manager-凭证"><span class="toc-number">1.4.5.</span> <span class="toc-text">生成 Controller Manager 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-Scheduler-凭证"><span class="toc-number">1.4.6.</span> <span class="toc-text">生成 Scheduler 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-Master-Kubelet-凭证"><span class="toc-number">1.4.7.</span> <span class="toc-text">生成 Master Kubelet 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-Service-Account-凭证"><span class="toc-number">1.4.8.</span> <span class="toc-text">生成 Service Account 凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分发文件-1"><span class="toc-number">1.4.9.</span> <span class="toc-text">分发文件</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/&text=虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/&title=虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/&is_video=false&description=虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书&body=Check out this article: xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/&title=虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/&title=虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/&title=虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/&title=虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=xiaofeise.com/2018/05/30/虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书/&name=虚拟机部署 Kubernetes v1.10.3  高可用集群 - 02 生成证书&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 萧非瑟 <a href="http://www.miitbeian.gov.cn">粤ICP备17119417号-1</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


